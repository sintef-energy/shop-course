{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "aff1930a",
   "metadata": {
    "tags": []
   },
   "source": [
    "# Introduction to PyShop"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d4f5411d",
   "metadata": {},
   "source": [
    "SHOP has oringally been run as a batch process where the user defines a model and input data through one or several files, and the exectuion process is specified by a command file. Similarly, the results are dumped as a set of output files. A more modern and flexible approach is to run SHOP through an API. An API (application programming interface) enables interaction with SHOP through programming code instead of only fixed predefined inputs, and this approach has several benefits such as:\n",
    "- SHOP can interact with other applications in a scheduling toolchain.\n",
    "- The setup of the optimization process is more flexible and we can program rules for how to execute the iterations.\n",
    "- Input and outputs are using the [pandas](https://pandas.pydata.org/) library that has a wide support for different input/output sources and formats.\n",
    "\n",
    "The native SHOP-API is written in C and only permits setting and getting primitive datatypes such as numbers, strings and arrays of number or strings. Therefore, setting timeseries and curves requires multiple API-calls. [pySHOP](https://github.com/sintef-energy/pyshop) is a wrapper written in Python that lifts the primitive C-API to a high-level API using pandas. Therefore, you can interact directly with the model through higher level attributes in Python. Moreover, the Python interface also offers convenient auto-completion when working in notebooks in a \"pythonic\" way."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b1e2f22e",
   "metadata": {},
   "source": [
    "## Installing PyShop\n",
    "This course will use SINTEF Energy's vLab for the pySHOP exercises. For local installation, please follow the guidelines provided at the SHOP portal: https://shop.sintef.energy/news/pyshop-becomes-an-official-python-package/"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4ba62f28",
   "metadata": {},
   "source": [
    "## External resources\n",
    "If you have low previous knowledge about programming and Python, we recommend to walk through a beginners guide. The official Python website gives a overview of some of the [available resources](https://wiki.python.org/moin/BeginnersGuide/Programmers) and there are many [Python introduction videos on YouTube](https://www.youtube.com/results?search_query=python+beginner+tutorial).\n",
    "\n",
    "## Getting started\n",
    "Python has, due to its simplicity, become on of the most used programming languages. Python has a built-in package manager where more than 200.000 packages can be installed by simply typing `pip install <package name>` in your terminal. This makes Python very well suited for gluing different component in your SHOP testing environment. [pandas](https://pandas.pydata.org/) is an open source library for managing structured data, and is used timeseries and curves in pySHOP. We will therefore, as shown in the first codeline below, import pandas and refer to it as pd for convenience. To start a ShopSession, we will also import the ShopSession class from pySHOP. This class enables us to create new instances of SHOP that are populated with data and optimized. The corrector is a set of functions that must be imported for this course to check your answers.\n",
    "\n",
    "Run the code below as shown a follow the instructions to build and run your first SHOP model in pySHOP."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f3c4f67e",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "from pyshop import ShopSession\n",
    "from corrector.basic import *"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "14343edd",
   "metadata": {},
   "source": [
    "To instantiate a new `ShopSession`, we simply call the class by appending the parantheses and assign the created session to the variable `shop`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "514133b5",
   "metadata": {},
   "outputs": [],
   "source": [
    "shop = ShopSession()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "79096e4a",
   "metadata": {},
   "source": [
    "### Setting the time horizon\n",
    "The time horizon, start and end time of the optimization, must be defined before adding any data by calling the `set_time_resolution` function as shown in the example below. We create a `Timestamp`, which is a object type in the pandas library and assign it the the variable `starttime`.\n",
    "\n",
    "#### Exercise\n",
    "Complete the code by filling the missing `***`:\n",
    "- create a new `Timestamp` named `endtime` 2 days later than `starttime`.\n",
    "- fill in the missing argument to `set_time_resolution`.\n",
    "- execute the code."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "af8a0bab",
   "metadata": {},
   "outputs": [],
   "source": [
    "starttime = pd.Timestamp('2022-01-01')\n",
    "endtime = pd.Timestamp('2022-01-03')\n",
    "shop.set_time_resolution(starttime=starttime, endtime=endtime, timeunit='hour')\n",
    "\n",
    "check_time_resolution(shop)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b1624868",
   "metadata": {
    "tags": []
   },
   "source": [
    "### Setting the time resolution (optional)\n",
    "The `set_time_resolution` function also specified the `timeunit` as `'hour'`. SHOP formulates an optimization model with discrete time steps. The default step size is given by the time unit. We can also use timeunit `'minutes'` and set the `timeresolution` to 60 as shown in the example below which is equivalent with hourly resolution. The `timeresolution` argument also enables variable step size in the model, for example, smaller step size in the first hours."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f6b46b14",
   "metadata": {},
   "outputs": [],
   "source": [
    "shop.set_time_resolution(starttime=starttime, endtime=endtime, timeunit='minute', timeresolution=pd.Series([60], index=[starttime]))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4cb5124e",
   "metadata": {},
   "source": [
    "### Creating objects\n",
    "All model building related features are located on the `model` object that is a sub-object of the `ShopSession`. pySHOP offers convenient typing help as shown in the video. Try it yourself below by typing `shop.model.` followed by the `tab` key."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "48990703",
   "metadata": {},
   "outputs": [],
   "source": [
    "shop.model"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "127d6b49",
   "metadata": {},
   "source": [
    "A SHOP model comprises multiple objects, both physical objects in the watercourse like reservoirs, plants and generators as well as more abstract objects types like markets and discharge_groups. Create a new `reservoir` by executing the code below."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2886663e",
   "metadata": {},
   "outputs": [],
   "source": [
    "rsv1 = shop.model.reservoir.add_object('Rsv1')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fa9fe014",
   "metadata": {},
   "source": [
    "#### Excercise\n",
    "Complete the code below to create a minimal working example:\n",
    "- create a `plant` named `'Plant1'`\n",
    "- create a `generator` named `'Plant1_G1'`"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "673a289e",
   "metadata": {},
   "outputs": [],
   "source": [
    "# plant1 = shop.model.plant.add_object(___)\n",
    "# ___\n",
    "\n",
    "## REMOVE\n",
    "plant1 = shop.model.plant.add_object('Plant1')\n",
    "gen1 = shop.model.generator.add_object('Plant1_G1')\n",
    "\n",
    "check_plant_and_generator_added(shop)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0b3da621",
   "metadata": {},
   "source": [
    "### Connecting objects\n",
    "Model relations are used both to connect the objects in the water course and to group objects logically. Execute the code below to connect your `reservoir` named `Rsv1` to the downstream `plant` named `Plant1`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ef29171d",
   "metadata": {},
   "outputs": [],
   "source": [
    "rsv1.connect_to(plant1)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7a6dc77a",
   "metadata": {},
   "source": [
    "In the case above, the objects we are connecting are stored in the variables `rsv1` and `plant1` respectively. Alternatively, you can also look up the objects directly in SHOP. The following code lines are all equivalent with the code we just executed:\n",
    "```python\n",
    "shop.model.reservoir.Rsv1.connect_to(shop.model.plant.Plant1)\n",
    "shop.model.reservoir['Rsv1'].connect_to(shop.model.plant['Plant1'])\n",
    "```\n",
    "\n",
    "The `['<ObjectName>']` syntax is a alternative to `.<ObjectName>` in situations where the object name contains characters that has a special meaning in Python such as `-()`, or if you are looking up as a part of a for-loop."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "36f2417c",
   "metadata": {},
   "source": [
    "#### Exercise\n",
    "Complete the code below by connecting your `generator` and `plant` with your preferred code syntax."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8f523577",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ***.connect_to(***)\n",
    "\n",
    "## REMOVE\n",
    "shop.model.generator.Plant1_G1.connect_to(plant1)\n",
    "\n",
    "check_plant_and_generator_connected(shop)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "77ec95fe",
   "metadata": {},
   "source": [
    "### Drawing topology\n",
    "Once your model is built, you can use the topology builder to visualize it. Exececute the code below to verify that the reservoir and plant has been connected correctly."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0a9f12fc",
   "metadata": {},
   "outputs": [],
   "source": [
    "shop.model.build_connection_tree()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a1f98816",
   "metadata": {},
   "source": [
    "### Setting model attributes\n",
    "The different objects in SHOP are parameterized through different attributes. You can use pySHOP to view all available attributes for the respective object types. Execute the code below to list all available attribute types for `reservoir`. Repeat for `plant`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "410780fb",
   "metadata": {},
   "outputs": [],
   "source": [
    "shop.model.reservoir.get_attribute_names()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2d3753c2",
   "metadata": {},
   "source": [
    "You can also get more detailed info about the respective attributes. Exectue the code below to show information about the `reservoir` attribute `lrl`. To create a minimal running example, we will set the attributes `lrl`, `hrl`, `max_vol`, `vol_head`, `flow_descr` and `inflow`. Check the information for each of these yourself."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "654fca6e",
   "metadata": {},
   "outputs": [],
   "source": [
    "shop.model.reservoir.Rsv1.lrl.info()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2e41073b",
   "metadata": {},
   "source": [
    "Each attribute is one of the following datatypes: int, int_array, double, double_array, txy (timeseries), xy (table), xy_array (list of tables), string, string_array, sy (table where the first column is a string). We use the `set()` function to set attribute values in SHOP.\n",
    "\n",
    "#### Exercise\n",
    "Run the code below to set the reservoir `hrl`. Complete the code and set the values according to the table below:\n",
    "|Object   |Attribute         |Value  |\n",
    "|---------|------------------|-------|\n",
    "|Rsv1     |lrl               |860    |\n",
    "|Rsv1     |start_head        |900    |\n",
    "|Rsv1     |energy_value_input|30     |\n",
    "|Plant1   |outlet_line       |670    |\n",
    "|Plant1   |penstock_loss     |[0.001]|\n",
    "|Plant1_G1|penstock          |1      |\n",
    "|Plant1_G1|p_min             |60     |\n",
    "|Plant1_G1|p_nom             |120    |\n",
    "|Plant1_G1|p_max             |120    |\n",
    "\n",
    "Outlet line denotes the altitude of the plant outlet. If there is no reservoir below, or the reservoir level is less than this, this is the plant downstream head. `penstock_loss` is the loss coefficient of the plant penstocks. The number of elements in the array represents the number of penstocks. `penstock` denotes which penstock the respective generator is connected to."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "72245fb5",
   "metadata": {},
   "outputs": [],
   "source": [
    "shop.model.reservoir.Rsv1.hrl.set(905)\n",
    "\n",
    "## REMOVE\n",
    "shop.model.reservoir.Rsv1.lrl.set(860)\n",
    "shop.model.reservoir.Rsv1.start_head.set(900)\n",
    "shop.model.reservoir.Rsv1.energy_value_input.set(30)\n",
    "shop.model.plant.Plant1.outlet_line.set(670)\n",
    "shop.model.plant.Plant1.penstock_loss.set([0.001])\n",
    "shop.model.generator.Plant1_G1.penstock.set(1)\n",
    "\n",
    "check_attribute_values1(shop)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c370a7c8",
   "metadata": {},
   "source": [
    "### Setting tables and timeseries values\n",
    "pySHOP uses pandas for setting more complex data structures like tables and timeseries. The `pandas.Series` can be used to represent a simple table with indexed values. Execute the code below to create a pandas series describing the relation between reservoir volume and head, and to visualize it with the built-in plotting function in pandas."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4b3540cd",
   "metadata": {},
   "outputs": [],
   "source": [
    "vol_head = pd.Series(\n",
    "    index = [0, 0.91, 1.87, 2.88, 5.07, 6.27, 7.56, 8.91, 10.34, 11.87, 13.53, 15.27, 17.11, 19.05, 21.1, 25.65, 27.96, 30.36, 35.18, 37.68, 39, 41.66],\n",
    "    data = [860, 862, 864, 866, 870, 872, 874, 876, 878, 880, 882, 884, 886, 888, 890, 894, 896, 898, 902, 904, 905, 907]\n",
    ")\n",
    "vol_head.plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e1b45797",
   "metadata": {},
   "source": [
    "We can define timeseries in a similar manner, but where the index must be `Timestamp` values instead of numbers. The code below shows how to define a simple timeseries using the `starttime` variable we defined in the beginning. Note that if all time steps are note specified, SHOP will assume the missing values are given by the previous known timestep (often referred to as forward fill interpolation/extrapolation)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d507fb0e",
   "metadata": {},
   "outputs": [],
   "source": [
    "example_txy = pd.Series(\n",
    "    data=[0, 50, 50],\n",
    "    index=[starttime, starttime+pd.Timedelta(hours=5), endtime]\n",
    ")\n",
    "example_txy.plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ba8f0bfa",
   "metadata": {},
   "source": [
    "#### Excercise\n",
    "Set the reservoir vol_head attribute to the `vol_head` curve defined above. Set the reservoir `inflow` attribute to 60 the first 12 hours and the reduce it to 30 for the remaining timesteps."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "238206c1",
   "metadata": {},
   "outputs": [],
   "source": [
    "## REMOVE\n",
    "shop.model.reservoir.Rsv1.vol_head.set(vol_head)\n",
    "shop.model.reservoir.Rsv1.inflow.set(pd.Series(data=[60, 30], index=[starttime, starttime+pd.Timedelta(hours=12)]))\n",
    "\n",
    "# check_tables1(shop)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0c47b3bb",
   "metadata": {},
   "source": [
    "### Turbine efficiency curves"
   ]
  }
 ],
 "metadata": {
  "interpreter": {
   "hash": "a99b379104e2ee1100f5ceda6b5755b760205edccc33bf6d14607a677128d7f1"
  },
  "kernelspec": {
   "display_name": "Python 3.10.2 64-bit",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.10.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
